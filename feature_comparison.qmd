# Feature Comparison
This method allows users to compare the distributions of a single numerical feature across groups. It can help users spot overarching trends between distributions, identify within distribution shape-related characteristics such as skewness or bimodality that might signal sub-populations, and diagnose for potential outliers. 

## Interface Components

![](analysis_ui_shots/feature_comparison.png)

### Shared Components 

- On the left, users can use the [selection widgets](data_analysis.qmd#univariate-analysis) to select the numerical feature to be compared. Exactly one feature can be selected from all feature groups. 
- On the top right, users can use the [filters](data_analysis.qmd#filter-widgets) to subset the data to find the groups of interest. 
- Below the filters, users can select the visual channels using the [visual channels widgets](data_analysis.qmd#visual-channels-widgets) that allows users to `Color by`, `Opacity by`, and `Shape by` categorical features. 
- On the bottom right, users can change the plot style using the [plot styling widgets](data_analysis.qmd#plotting-configuration-widgets). 

### Separate by
![](analysis_ui_shots/separate_by_widget.png)

`Separate by` takes effect before [`Color by`](data_analysis.qmd#color-by). `Separate by` divides the plot into sections separated by a dashed line, with each section labeled by one of the available categories of the selected categorical feature after [filtering](data_analysis.qmd#filter-widgets). The selected feature of `Separate by` is automatically removed from available features in `Color by`. The section order is determined by the order of the categories which are sorted [numer-alphatically](data_analysis.qmd#nte-order). 

Then, visual channels (color, shape, opacity) and effect size annotation are applied within each section. For example, the visualization below was separated by `cell_line`, with each section labelled by the bold text of a cell line. Within each section, the x-axis rendered the `Color by` categories (`treatments`) so colors were consistent across sections. [Effect size](#effect-size) calculation and annotation (only effect size $> 0.5$ is shown) were performed within each section. 

![](analysis_ui_shots/separate_by.png)

If selecting no feature in `Separate by` and selecting both `cell_line` and `treatment` in `Color by`, then colors are assigned to each cell line and treatment combination, and effect sizes are calculated across all combinations of group pairs (only effect size $> 0.5$ is shown). 

![](analysis_ui_shots/no_separate_by.png)

### Effect Size 
Complementary to parametric tests, which address “is there a difference?”, effect size metrics answer “how large is the difference?”. A p-value that is significant can come from a trivial difference in a huge dataset (e.g. large single-cell datasets), whereas effect size can be more meaningful and can enable cross-study comparison. FLIM Playground offers two effect size calculation methods (significance tests may be added later), Glass's Delta and Cohen's d, each can be in mean or median form. 

![](analysis_ui_shots/effect_size.png){width=40% fig-align=center}

#### Glass's Delta

Mean ($\bar{X}$) form:
$$
\Delta_G
  = \frac{\bar{X}_{\text{treatment}} - \bar{X}_{\text{control}}}
         {s_{\text{control}}},\qquad
s_{\text{control}}
  = \sqrt{\frac{1}{\,n_c-1\,}\sum_{i=1}^{n_c}
           \bigl(X_{ci}-\bar{X}_{\text{control}}\bigr)^{2}}
$$

Median ($\tilde{X}$) form:
$$
\widetilde{\Delta}_G
  = \frac{\tilde{X}_{\text{treatment}} - \tilde{X}_{\text{control}}}
         {\operatorname{MAD}_{\text{control}}},\qquad
\operatorname{MAD}_{\text{control}}
  = 1.4826 \times
    \operatorname{median}\!\bigl\lvert
      X_{ci}-\tilde{X}_{\text{control}}
    \bigr\rvert
$$

:::{.callout-note}
$\operatorname{MAD}$ stands for median absolute deviation, a robust measure of the variability of a univariate sample. In order to make $\operatorname{MAD}$ asymptotically consistent with the standard deviation under normality, it uses $C = 1 / \Phi^{-1}(0.75) \approx 1.4826$. Implementation-wise, it uses `median_abs_deviation` from `scipy.stats`, and `scale` option is set to `"normal"` to account for the constant multiplier $C$. 
:::

::: {.callout-important}
Who is treatment and who is control matters! From the formula of $\Delta_G$, switching the order not only flips the sign of the result, but also changes the denominator, which is ${s_{\text{control}}}$, the standard deviation of the *control*. Currently, FLIM Playground treats the group on the left as treatment and the group on the right as control (the negative $\Delta_G$ below implies this). In the future, it may support user-customizable x-axis order so that users can arrange the groups to make sure the treatment group is on the left. Or users can use [Cohen's d](#cohens-d) that does not assume the treatment-control structure.

![](analysis_ui_shots/glass_d.png){width=40% fig-align=center}
:::

:::{.callout-note}
To keep the point-based visulization style that supports [interactive hover](data_analysis.qmd#unique-id-hover) while showing the violin plot like distribution, [Sina plot](https://en.wikipedia.org/wiki/Sina_plot) is used: it uses `gaussian_kde` from `scikit-learn` to make sure the width of the point distribution is proportional to the kernel density. 
:::

#### Cohen's d
Mean ($\bar{X}$) form:

$$
d
  = \frac{\bar{X}_{1}-\bar{X}_{2}}
         {s_p},\qquad
s_p
  = \sqrt{\frac{(n_1-1)s_1^{2} + (n_2-1)s_2^{2}}
                 {n_1 + n_2 - 2}}
$$

Median ($\tilde{X}$) form:

$$
\tilde{d}
  = \frac{\tilde{X}_{1}-\tilde{X}_{2}}
         {s_{\tilde{p}}},\qquad
s_{\tilde{p}}
  = \sqrt{\frac{(n_1-1)\operatorname{MAD}_{1}^{2}
             + (n_2-1)\operatorname{MAD}_{2}^{2}}
                 {n_1 + n_2 - 2}}
$$

#### Effect Size Widgets 

It requires pairs of groups to calculate effect sizes. FLIM Playground uses the groups on the x-axis populated by [Color by](data_analysis.qmd#color-by) to create comparison groups, starting from the leftmost group. For example, if there are 5 groups, then $\binom{5}{2} = 10$ comparisons will be created. The number of groups can get combinatorially large and many of the comparisons are not meaningful. Therefore, two widgets are provided to filter the comparison groups: 

- A selection widget that shows all possible comparisons by default and users can deselect groups they do not need.
- A threshold by effect size widget that filters out comparisons below the threshold. 

![](analysis_ui_shots/effect_size_widgets.png)

#### Effect size annotation

For each selected pair of groups that exceeds the effect size threshold, the effect size is annotated on the plot. It selects the lowest eligible position (over all points in both groups and over existing annotations) to annotate the effect size.  